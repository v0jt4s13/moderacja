{% extends "base.html" %}

{% block title %}Materia≈Çy reklamowe{% endblock %}

{% block header_title %}üñºÔ∏è Materia≈Çy reklamowe{% endblock %}

{% block content %}
<style>
  .panel-form { display: grid; gap: 12px; margin-bottom: 20px; }
  .panel-form textarea {
    min-height: 120px;
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 12px;
    resize: vertical;
    font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }
  .panel-form button {
    justify-self: flex-start;
  }
  .gallery-results { display: grid; gap: 18px; }
  .gallery-entry { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: var(--panel); box-shadow: var(--shadow); }
  .entry-header { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  .entry-meta { font-size: 13px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 12px; }
  .assets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
  .asset-card { display: grid; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: color-mix(in oklab, var(--panel), var(--bg) 20%); }
  .asset-card img, .asset-card video { width: 100%; border-radius: 8px; background: var(--bg); }
  .asset-meta { font-size: 12px; color: var(--muted); display: grid; gap: 4px; }
  .status-msg { padding: 12px 14px; border-radius: 10px; }
  .status-error { background: rgba(220, 38, 38, 0.12); border: 1px solid rgba(220, 38, 38, 0.35); color: #dc2626; }
  .status-warn { background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); color: #b45309; }
  .folders { display: grid; gap: 6px; margin: 10px 0; }
  .folders-list { display: flex; flex-wrap: wrap; gap: 8px; }
  .folder-chip { display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius: 999px; background: var(--panel); font-size: 12px; }
  .folder-chip a{ text-decoration:none; }
</style>

<div class="panel panel-form">
  <form method="get" class="panel-form">
    <label for="s3Paths">Adresy S3</label>
    <input type="text" id="s3Paths" name="s3_paths" placeholder="np. https://assets.aws.example.com/news_to_video/materialy/kampania_01/" value="{{ paths_input }}" />
    <button type="submit" class="btn primary">Poka≈º galeriƒô</button>
    <br>https://jdblayer-assets-static.s3.eu-west-2.amazonaws.com/londynek/
    <br>
  </form>
</div>

{% if error %}
  <div class="status-msg status-error">B≈ÇƒÖd: {{ error }}</div>
{% endif %}

{% if results %}
  <div class="gallery-results">
    {% for entry in results %}
      <div class="gallery-entry">
        <div class="entry-header">
          <div><strong>≈πr√≥d≈Ço:</strong> <code>{{ entry.input }}</code></div>
          {% if entry.error %}
            <div class="status-msg status-error">Nie uda≈Ço siƒô pobraƒá danych: {{ entry.error }}</div>
          {% else %}
            <div class="entry-meta">
              <span><strong>Bucket:</strong> {{ entry.bucket or "‚Äî" }}</span>
              <span><strong>Prefiks:</strong> <code>{{ entry.prefix or entry.requested_prefix or "‚Äî" }}</code></span>
              <span><strong>Liczba element√≥w:</strong> {{ entry.count }}</span>
            </div>
            {% if entry.warning %}
              <div class="status-msg status-warn">{{ entry.warning }}</div>
            {% endif %}
          {% endif %}
        </div>

        {# FOLDERY POD PREFIKSEM #}
        {% set folders = entry['folders'] if 'folders' in entry else [] %}
        {% set folders_info = entry['folders_info'] if 'folders_info' in entry else [] %}
        {% if folders %}
          <div class="folders">
            <div class="entry-meta"><strong>Foldery ({{ folders|length }}):</strong></div>
            <div class="folders-list">
              {% for f in folders_info %}
                {% set label = (f.key.rstrip('/').split('/')[-1]) or f.key %}
                <span class="folder-chip"><a href="{{ f.url }}" target="_blank" rel="noopener" class="folder-link" data-path="{{ f.url }}">üìÅ {{ label }}</a></span>
              {% endfor %}
            </div>
            <div>
              <button type="button" class="btn add-folders-btn" data-folderlist="{{ folders|join('\n') }}">Wstaw foldery do pola</button>
            </div>
          </div>
          {% if entry.pages and entry.pages > 1 %}
            <div class="btn-row" style="margin-top:10px;">
              <form method="get" style="display:inline-flex; gap:8px; align-items:center;">
                <input type="hidden" name="s3_paths" value="{{ paths_input }}" />
                <input type="hidden" name="per_page" value="{{ entry.per_page }}" />
                <button class="btn" type="submit" name="page" value="{{ entry.page - 1 }}" {% if entry.page <= 1 %}disabled{% endif %}>‚óÄ Poprzednia</button>
                <button class="btn" type="submit" name="page" value="{{ entry.page + 1 }}" {% if entry.page >= entry.pages %}disabled{% endif %}>Nastƒôpna ‚ñ∂</button>
              </form>
            </div>
          {% endif %}
        {% endif %}

        {% set items = entry['items'] %}
        {% if items %}
          <div class="assets-grid">
            {% for asset in items %}
              <div class="asset-card">
                {% if asset.type == 'image' %}
                  <img src="{{ asset.url }}" alt="{{ asset.key }}">
                {% else %}
                  <video src="{{ asset.url }}" controls preload="metadata"></video>
                {% endif %}
                <div class="asset-meta">
                  <div><a href="{{ asset.url }}" target="_blank" rel="noopener">{{ asset.key }}</a></div>
                  <div>
                    {% if asset.size_human %}{{ asset.size_human }}{% else %}‚Äî{% endif %}
                    {% if asset.last_modified %} ‚Ä¢ {{ asset.last_modified }}{% endif %}
                    ‚Ä¢ {{ asset.type }}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% elif submitted and not error %}
  <div class="status-msg status-warn">Podaj adres lub prefiks S3, aby wy≈õwietliƒá materia≈Çy.</div>
{% endif %}
<script>
  (function(){
    const ta = document.getElementById('s3Paths');
    // Klik w folder ‚Äî wstaw do textarea i wy≈õlij formularz
    document.querySelectorAll('.folder-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        if (!ta) return;
        ta.value = a.dataset.path || '';
        ta.form && ta.form.submit();
      });
    });
    // Wstaw wszystkie foldery z wpisu do pola (bez submit)
    document.querySelectorAll('.add-folders-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!ta) return;
        ta.value = btn.dataset.folderlist || '';
        ta.focus();
      });
    });
  })();
</script>
{% endblock %}

